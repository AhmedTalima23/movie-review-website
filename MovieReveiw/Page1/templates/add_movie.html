<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Movie - MovieReview Admin</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Admin Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <h1><a href="{% url 'admin_home' %}">Movie<span>Review</span> Admin</a></h1>
                <ul>
                    <li><a href="{% url 'admin_home' %}">Dashboard</a></li>
                    <li><a href="#" class="active">Add Movie</a></li>
                    <li><a href="{% url 'manage_movies' %}" title="Manage all movies">Manage Movies</a></li>
                    <li><a href="#">Manage Reviews</a></li>
                    <li><a href="{% url 'logout' %}">Logout</a></li>
                </ul>
                <div class="bar-icon">☰</div>
            </div>
        </div>
    </nav>

    <!-- Add Movie Form -->
    <section class="container">
        <div class="head-style">
            <h2>Add New Movie</h2>
            <p>Expand Your <span>Collection</span></p>
        </div>

        <form id="addMovieForm">
            <label for="movieId">Movie ID (Optional)</label>
            <input type="text" id="movieId" name="movieId" placeholder="Enter unique movie ID (e.g., M001) or leave blank to auto-generate from title" pattern="M[0-9]{3,}">
            <small class="hint-text">Leave blank to auto-generate from title, or use format: M followed by at least 3 digits</small>

            <label for="title">Movie Title *</label>
            <input type="text" id="title" name="title" required placeholder="Enter movie title" minlength="1" maxlength="200">

            <label for="genre">Genre *</label>
            <select id="genre" name="genre" required>
                <option value="">Select primary genre</option>
                <option value="Action">Action</option>
                <option value="Adventure">Adventure</option>
                <option value="Animation">Animation</option>
                <option value="Comedy">Comedy</option>
                <option value="Crime">Crime</option>
                <option value="Documentary">Documentary</option>
                <option value="Drama">Drama</option>
                <option value="Fantasy">Fantasy</option>
                <option value="Horror">Horror</option>
                <option value="Mystery">Mystery</option>
                <option value="Romance">Romance</option>
                <option value="Sci-Fi">Sci-Fi</option>
                <option value="Thriller">Thriller</option>
                <option value="Western">Western</option>
            </select>

            <label for="additionalGenres">Additional Genres (Optional)</label>
            <input type="text" id="additionalGenres" name="additionalGenres" placeholder="e.g., Thriller, Mystery (comma-separated)">

            <label for="releaseYear">Release Year *</label>
            <input type="number" id="releaseYear" name="releaseYear" required placeholder="Enter release year" min="1888" max="2025">

            <label for="director">Director *</label>
            <input type="text" id="director" name="director" required placeholder="Enter director name" minlength="2">

            <label for="cast">Main Cast (Optional)</label>
            <input type="text" id="cast" name="cast" placeholder="e.g., Actor 1, Actor 2, Actor 3 (comma-separated)">

            <label for="duration">Duration (minutes)</label>
            <input type="number" id="duration" name="duration" placeholder="Enter movie duration in minutes" min="1">

            <label for="rating">Content Rating (Optional)</label>
            <select id="rating" name="rating">
                <option value="">Select content rating</option>
                <option value="G">G - General Audiences</option>
                <option value="PG">PG - Parental Guidance Suggested</option>
                <option value="PG-13">PG-13 - Parents Strongly Cautioned</option>
                <option value="R">R - Restricted</option>
                <option value="NC-17">NC-17 - Adults Only</option>
            </select>

            <label for="imdbRating">IMDb Rating (out of 10) *</label>
            <input type="number" id="imdbRating" name="imdbRating" required placeholder="Enter IMDb rating (e.g., 8.5)" min="0" max="10" step="0.1">

            <label for="description">Description *</label>
            <textarea id="description" name="description" required placeholder="Enter movie description/plot summary" rows="6" minlength="20"></textarea>

            <label for="poster">Poster Image URL</label>
            <input type="url" id="poster" name="poster" placeholder="Enter poster image URL (e.g., https://example.com/poster.jpg)">

            <label for="trailer">Trailer URL (Optional)</label>
            <input type="url" id="trailer" name="trailer" placeholder="Enter trailer URL (e.g., YouTube link)">

            <label for="language">Language *</label>
            <input type="text" id="language" name="language" required placeholder="Enter primary language" value="English">

            <label for="country">Country *</label>
            <input type="text" id="country" name="country" required placeholder="Enter country of origin" value="USA">

            <button type="submit">Add Movie</button>
            <button type="reset" class="btn reset">Reset Form</button>
        </form>

        <p style="text-align: center; margin-top: 1rem;">
            <a href="#" style="color: var(--primary-color);">← Back to Manage Movies</a>
        </p>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 MovieReview. All rights reserved.</p>
            <p>Admin Dashboard - Manage your movie review platform.</p>
        </div>
    </footer>

    <script>
        // Function to get CSRF token from cookies
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to show success message
        function showSuccessMessage(message) {
            // Remove any existing messages
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            // Create and show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message success';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <span class="message-icon">✓</span>
                    <span class="message-text">${message}</span>
                    <span class="message-close" onclick="this.parentElement.parentElement.remove()">×</span>
                </div>
            `;

            document.body.appendChild(messageDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Function to show error message
        function showErrorMessage(message) {
            // Remove any existing messages
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            // Create and show error message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message error';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <span class="message-icon">✕</span>
                    <span class="message-text">${message}</span>
                    <span class="message-close" onclick="this.parentElement.parentElement.remove()">×</span>
                </div>
            `;

            document.body.appendChild(messageDiv);

            // Scroll to top to show message
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Handle add movie form submission
        document.addEventListener('DOMContentLoaded', function() {
            const addMovieForm = document.getElementById('addMovieForm');

            if (addMovieForm) {
                addMovieForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // Get form values
                    const formData = {
                        title: document.getElementById('title').value.trim(),
                        genre: document.getElementById('genre').value,
                        additionalGenres: document.getElementById('additionalGenres').value.trim(),
                        releaseYear: document.getElementById('releaseYear').value,
                        director: document.getElementById('director').value.trim(),
                        cast: document.getElementById('cast').value.trim(),
                        duration: document.getElementById('duration').value,
                        rating: document.getElementById('rating').value,
                        imdbRating: document.getElementById('imdbRating').value,
                        description: document.getElementById('description').value.trim(),
                        poster: document.getElementById('poster').value.trim(),
                        trailer: document.getElementById('trailer').value.trim(),
                        language: document.getElementById('language').value.trim(),
                        country: document.getElementById('country').value.trim()
                    };

                    // Validate required fields
                    if (!formData.title) {
                        showErrorMessage('Movie title is required.');
                        return;
                    }

                    if (!formData.genre) {
                        showErrorMessage('Primary genre is required.');
                        return;
                    }

                    if (!formData.releaseYear) {
                        showErrorMessage('Release year is required.');
                        return;
                    }

                    if (!formData.director) {
                        showErrorMessage('Director is required.');
                        return;
                    }

                    if (!formData.description || formData.description.length < 20) {
                        showErrorMessage('Description is required and must be at least 20 characters.');
                        return;
                    }

                    if (!formData.language) {
                        showErrorMessage('Language is required.');
                        return;
                    }

                    if (!formData.country) {
                        showErrorMessage('Country is required.');
                        return;
                    }

                    if (!formData.imdbRating || isNaN(formData.imdbRating) || parseFloat(formData.imdbRating) < 0 || parseFloat(formData.imdbRating) > 10) {
                        showErrorMessage('IMDb rating is required and must be between 0 and 10.');
                        return;
                    }

                    // Show loading state
                    const submitButton = addMovieForm.querySelector('button[type="submit"]');
                    const originalText = submitButton.textContent;
                    submitButton.textContent = 'Adding Movie...';
                    submitButton.disabled = true;

                    // Send AJAX request to Django backend
                    fetch('/add_movie/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccessMessage(data.message);
                            addMovieForm.reset();

                            // Optionally redirect after 2 seconds
                            setTimeout(() => {
                                if (confirm('Movie added successfully! Would you like to add another movie?')) {
                                    // Stay on page
                                } else {
                                    
                                    // Could redirect to manage movies if that view exists
                                    // window.location.href = '/manage_movies/';
                                }
                            }, 2000);
                        } else {
                            showErrorMessage(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showErrorMessage('An error occurred while adding the movie. Please try again.');
                    })
                    .finally(() => {
                        // Reset button state
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    });
                });
            }
        });
    </script>
</body>
</html>