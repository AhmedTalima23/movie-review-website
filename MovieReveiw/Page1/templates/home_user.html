<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - MovieReview</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/pages/user.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <h1><a href="/">Movie<span>Review</span></a></h1>
                <ul id="navLinks">
                    <li><a href="/" class="active">Home</a></li>
                    <li><a href="/pages/user/movie_list.html">Browse Movies</a></li>
                    <li><a href="/pages/user/my_reviews.html">My Reviews</a></li>
                    <li><a href="/pages/user/profile.html">Profile</a></li>
                    <li><a href="/logout/">Logout</a></li>
                </ul>
                <div class="bar-icon">â˜°</div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-text">
                    <h2>Welcome Back, <span id="userName">{{ user.name|default:"User" }}!</span></h2>
                    <p>Continue exploring amazing movies and share your reviews with the community.
                       Discover trending films, revisit your favorites, and express your cinematic voice.</p>
                    <div class="header-btn">
                        <a href="/pages/user/movie_list.html" class="book-btn">Browse Movies</a>
                        <a href="/pages/user/my_reviews.html" class="watch-btn">My Reviews</a>
                    </div>
                </div>
                <div class="header-img">
                    <img src="{% static 'img/movies/samuel-regan-asante-wMkaMXTJjlQ-unsplash.jpg' %}" alt="Movie Collection">
                </div>
            </div>
        </div>
    </section>

    <!-- Search Section -->
    <section class="container mt-1" aria-label="Search Section">
        <div class="head-style">
            <h2>Search Movies</h2>
            <p>Find Your <span>Favorite</span></p>
        </div>

        <form id="searchForm" class="form-max">
            <div class="form-group">
                <label for="searchBy">Search By</label>
                <select id="searchBy" name="searchBy" required>
                    <option value="">Select search criteria</option>
                    <option value="title">Title</option>
                    <option value="genre">Genre</option>
                    <option value="year">Release Year</option>
                    <option value="director">Director</option>
                </select>
            </div>

            <div class="form-group">
                <label for="searchQuery">Search Query</label>
                <input type="text" id="searchQuery" name="searchQuery" required placeholder="Enter your search term">
            </div>

            <button type="submit" class="btn">Search</button>
        </form>
    </section>

    <!-- Trending Movies -->
    <section class="container">
        <div class="head-style">
            <h2>Featured Movies</h2>
            <p>Popular <span>This Week</span></p>
        </div>

        <div class="movie-list" id="movieList">
            <p>Loading movies...</p>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 MovieReview. All rights reserved.</p>
            <p>Discover, Review, and Rate your favorite movies.</p>
        </div>
    </footer>

    <script>
        // Pass user data from Django to JavaScript
        const currentUser = JSON.parse('{{ user|default:"null"|escapejs }}');
        const isLoggedIn = currentUser !== null;

        // Function to check if user is logged in
        function isLoggedIn() {
            return isLoggedIn;
        }

        // Function to get current user
        function getCurrentUser() {
            return currentUser;
        }

        // Function to update navigation based on login status
        function updateNavigation() {
            const navLinks = document.getElementById('navLinks');
            const user = getCurrentUser();

            if (user) {
                // User is logged in - show user menu
                navLinks.innerHTML = `
                    <li><a href="/" class="active">Home</a></li>
                    <li><a href="/pages/user/movie_list.html">Browse Movies</a></li>
                    <li><a href="/pages/user/my_reviews.html">My Reviews</a></li>
                    <li><a href="/pages/user/profile.html">Profile</a></li>
                    <li><a href="/logout/">Logout</a></li>
                `;
            } else {
                // User is not logged in - show guest menu
                navLinks.innerHTML = `
                    <li><a href="/" class="active">Home</a></li>
                    <li><a href="/login/">Login</a></li>
                    <li><a href="/signup/">Sign Up</a></li>
                `;
            }
        }

        // Load movies from database
        function loadMovies() {
            const movieList = document.getElementById('movieList');
            movieList.innerHTML = '<p>Loading movies...</p>';
            fetch('/get_movies/')
                .then(response => response.json())
                .then(movies => {
                    if (movies.length === 0) {
                        movieList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No movies available. Check back later!</p>';
                        return;
                    }

                    // Limit to first 6 movies for featured section
                    const featuredMovies = movies.slice(0, 6);

                    movieList.innerHTML = featuredMovies.map(movie => {
                        const posterUrl = movie.poster_url || '{% static "img/movies/default.jpg" %}';
                        return `
                            <div class="movie">
                                <img src="${posterUrl}" alt="${movie.title}" onerror="this.src='{% static 'img/movies/default.jpg' %}'">
                                <div class="movie-info">
                                    <h3>${movie.title}</h3>
                                    <p><strong>Genre:</strong> ${movie.genre} | <strong>Year:</strong> ${movie.release_date ? new Date(movie.release_date).getFullYear() : 'N/A'} | <strong>Director:</strong> ${movie.director}</p>
                                    <p>No description available.</p>
                                    <a href="/pages/user/movie_details.html?movie=${movie.moID}" class="btn">View Details</a>
                                    <a href="/pages/user/submit_review.html?movie=${movie.moID}" class="btn add-review">Add Review</a>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(error => {
                    console.error('Error loading movies:', error);
                    movieList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">Error loading movies. Please try again later.</p>';
                });
        }

        // Handle search form
        function setupSearchForm() {
            const searchForm = document.getElementById('searchForm');

            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const searchQuery = document.getElementById('searchQuery').value;
                    const searchBy = document.getElementById('searchBy').value;

                    if (searchQuery && searchBy) {
                        // Redirect to movie list page with search parameters
                        window.location.href = `/pages/user/movie_list.html?search=${encodeURIComponent(searchQuery)}&by=${encodeURIComponent(searchBy)}`;
                    } else {
                        alert('Please select a search criteria and enter a search term.');
                    }
                });
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            setupSearchForm();
            loadMovies();
        });
    </script>
</body>
</html>
