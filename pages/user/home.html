<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - MovieReview</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/pages/user.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <h1><a href="home.html">Movie<span>Review</span></a></h1>
                <ul>
                    <li><a href="home.html" class="active">Home</a></li>
                    <li><a href="movie_list.html">Browse Movies</a></li>
                    <li><a href="my_reviews.html">My Reviews</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="../auth/logout.html">Logout</a></li>
                </ul>
                <div class="bar-icon">â˜°</div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-text">
                    <h2>Welcome Back, <span id="userName">User!</span></h2>
                    <p>Continue exploring amazing movies and share your reviews with the community.
                       Discover trending films, revisit your favorites, and express your cinematic voice.</p>
                    <div class="header-btn">
                        <a href="movie_list.html" class="book-btn">Browse Movies</a>
                        <a href="my_reviews.html" class="watch-btn">My Reviews</a>
                    </div>
                </div>
                <div class="header-img">
                    <img src="../../assets/img/movies/samuel-regan-asante-wMkaMXTJjlQ-unsplash.jpg" alt="Movie Collection">
                </div>
            </div>
        </div>
    </section>

    <!-- Search Section -->
    <section class="container mt-1" aria-label="Search Section">
        <div class="head-style">
            <h2>Search Movies</h2>
            <p>Find Your <span>Favorite</span></p>
        </div>

        <form id="searchForm" class="form-max">
            <div class="form-group">
                <label for="searchBy">Search By</label>
                <select id="searchBy" name="searchBy" required>
                    <option value="">Select search criteria</option>
                    <option value="title">Title</option>
                    <option value="genre">Genre</option>
                    <option value="year">Release Year</option>
                    <option value="director">Director</option>
                </select>
            </div>

            <div class="form-group">
                <label for="searchQuery">Search Query</label>
                <input type="text" id="searchQuery" name="searchQuery" required placeholder="Enter your search term">
            </div>

            <button type="submit" class="btn">Search</button>
        </form>
    </section>

    <!-- Trending Movies -->
    <section class="container">
        <div class="head-style">
            <h2>Featured Movies</h2>
            <p>Popular <span>This Week</span></p>
        </div>

        <div class="movie-list" id="movieList">
            <!-- Movies will be loaded dynamically from localStorage -->
            <p style="text-align: center; color: #999; padding: 2rem;">Loading movies...</p>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 MovieReview. All rights reserved.</p>
            <p>Discover, Review, and Rate your favorite movies.</p>
        </div>
    </footer>

    <script>
        // Function to check if user is logged in
        function isLoggedIn() {
            const currentUser = localStorage.getItem('currentUser');
            return currentUser !== null;
        }

        // Function to get current user
        function getCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    return JSON.parse(currentUser);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // Function to get all movies from localStorage
        function getAllMovies() {
            const movies = localStorage.getItem('movies');
            if (movies) {
                try {
                    const moviesArray = JSON.parse(movies);
                    // Convert array to object with movieId as key for backward compatibility
                    const moviesObj = {};
                    moviesArray.forEach(movie => {
                        const movieId = movie.movieId || movie.id || generateMovieId(movie.title);
                        moviesObj[movieId] = {
                            title: movie.title,
                            image: movie.poster || movie.image || '../../assets/img/movies/default.jpg',
                            genre: movie.additionalGenres ? `${movie.genre || ''}, ${movie.additionalGenres}` : (movie.genre || ''),
                            year: movie.releaseYear || movie.year || '',
                            movieId: movieId,
                            director: movie.director || '',
                            description: movie.description || '',
                            cast: movie.cast || '',
                            duration: movie.duration || '',
                            rating: movie.rating || '',
                            language: movie.language || '',
                            country: movie.country || '',
                            trailer: movie.trailer || ''
                        };
                    });
                    return moviesObj;
                } catch (e) {
                    console.error('Error parsing movies from localStorage:', e);
                    return getDefaultMovies();
                }
            }
            // Fallback to default movies for backward compatibility
            return getDefaultMovies();
        }

        // Function to generate movie ID from title
        function generateMovieId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        // Default movies for backward compatibility
        function getDefaultMovies() {
            return {
                'the-shawshank-redemption': {
                    title: 'The Shawshank Redemption',
                    image: '../../assets/img/movies/shaw.jpg',
                    genre: 'Drama',
                    year: '1994',
                    movieId: 'the-shawshank-redemption',
                    director: 'Frank Darabont',
                    description: 'Two imprisoned men bond over years, finding solace and eventual redemption through acts of decency.'
                },
                'the-dark-knight': {
                    title: 'The Dark Knight',
                    image: '../../assets/img/movies/R.jpeg',
                    genre: 'Action, Crime',
                    year: '2008',
                    movieId: 'the-dark-knight',
                    director: 'Christopher Nolan',
                    description: 'When the menace known as the Joker causes chaos in Gotham, Batman faces his greatest moral test yet.'
                },
                'the-godfather': {
                    title: 'The Godfather',
                    image: '../../assets/img/movies/godf.jpg',
                    genre: 'Crime, Drama',
                    year: '1972',
                    movieId: 'the-godfather',
                    director: 'Francis Ford Coppola',
                    description: 'The aging patriarch of an organized crime dynasty transfers control of his empire to his reluctant son.'
                }
            };
        }

        // Function to display movies
        function displayMovies() {
            const movieList = document.getElementById('movieList');
            if (!movieList) return;

            const movies = getAllMovies();
            const movieArray = Object.values(movies);

            if (movieArray.length === 0) {
                movieList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No movies available. Check back later!</p>';
                return;
            }

            // Limit to first 6 movies for featured section
            const featuredMovies = movieArray.slice(0, 6);

            movieList.innerHTML = featuredMovies.map(movie => {
                const genreDisplay = movie.genre || 'N/A';
                const yearDisplay = movie.year || 'N/A';
                const directorDisplay = movie.director || 'N/A';
                const description = movie.description || 'No description available.';
                const imageSrc = movie.image || '../../assets/img/movies/default.jpg';

                return `
                    <div class="movie">
                        <img src="${imageSrc}" alt="${movie.title}" onerror="this.src='../../assets/img/movies/default.jpg'">
                        <div class="movie-info">
                            <h3>${movie.title}</h3>
                            <p><strong>Genre:</strong> ${genreDisplay} | <strong>Year:</strong> ${yearDisplay} | <strong>Director:</strong> ${directorDisplay}</p>
                            <p>${description.length > 150 ? description.substring(0, 150) + '...' : description}</p>
                            <a href="movie_details.html?movie=${encodeURIComponent(movie.movieId)}" class="btn">View Details</a>
                            <a href="submit_review.html?movie=${encodeURIComponent(movie.movieId)}" class="btn add-review">Add Review</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Function to personalize the page
        function personalizePage() {
            const user = getCurrentUser();
            
            if (user) {
                // Update welcome message with user's name
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = user.name + '!';
                }
            } else {
                // If not logged in, redirect to login page
                window.location.href = '../auth/login.html';
            }
        }

        // Handle search form
        function setupSearchForm() {
            const searchForm = document.getElementById('searchForm');
            
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const searchQuery = document.getElementById('searchQuery').value;
                    const searchBy = document.getElementById('searchBy').value;
                    
                    if (searchQuery && searchBy) {
                        // Redirect to movie list page with search parameters
                        window.location.href = `movie_list.html?search=${encodeURIComponent(searchQuery)}&by=${encodeURIComponent(searchBy)}`;
                    } else {
                        alert('Please select a search criteria and enter a search term.');
                    }
                });
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            personalizePage();
            setupSearchForm();
            displayMovies();
        });
    </script>
</body>
</html>
