<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MovieReview</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Admin Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <h1><a href="home.html">Movie<span>Review</span> Admin</a></h1>
                <ul>
                    <li><a href="home.html">Dashboard</a></li>
                    <li><a href="add_movie.html">Add Movie</a></li>
                    <li><a href="manage_movies.html">Manage Movies</a></li>
                    <li><a href="manage_reviews.html">Manage Reviews</a></li>
                    <li><a href="../auth/logout.html">Logout</a></li>
                </ul>
                <div class="bar-icon">â˜°</div>
            </div>
        </div>
    </nav>

    <!-- Admin Dashboard -->
    <section class="container admin-panel">
        <div class="head-style">
            <h2>Admin Dashboard</h2>
            <p>Welcome <span id="adminName">Administrator</span></p>
        </div>

        <!-- Statistics Cards -->
        <div class="admin-stat-grid">
            <!-- Total Movies Card -->
            <div class="stat-card">
                <h3 style="font-size: 3rem; color: var(--accent-color); margin-bottom: 0.5rem;" id="totalMovies">0</h3>
                <p style="color: var(--secondary-color); font-size: 1.2rem;">Total Movies</p>
            </div>

            <!-- Pending Reviews Card -->
            <div class="stat-card alt-orange">
                <h3 style="font-size: 3rem; color: #FFA500; margin-bottom: 0.5rem;" id="totalReviews">0</h3>
                <p style="color: var(--secondary-color); font-size: 1.2rem;">Total Reviews</p>
            </div>

            <!-- Total Users Card -->
            <div class="stat-card alt-green">
                <h3 style="font-size: 3rem; color: #4CAF50; margin-bottom: 0.5rem;" id="totalUsers">0</h3>
                <p style="color: var(--secondary-color); font-size: 1.2rem;">Registered Users</p>
            </div>

            <!-- Movies Reviewed Card -->
            <div class="stat-card alt-primary">
                <h3 style="font-size: 3rem; color: var(--primary-color); margin-bottom: 0.5rem;" id="moviesReviewed">0</h3>
                <p style="color: var(--secondary-color); font-size: 1.2rem;">Movies Reviewed</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="head-style" style="margin-top: 3rem;">
            <h2>Quick Actions</h2>
            <p>Manage Your <span>Platform</span></p>
        </div>

        <div class="quick-actions">
            <!-- Add Movie -->
            <div class="action-card">
                <h3 style="color: var(--secondary-color); margin-bottom: 1rem;">Add New Movie</h3>
                <p style="color: #b0b0b0; margin-bottom: 1.5rem;">Add a new movie to the platform database</p>
                <a href="add_movie.html" class="btn">Add Movie</a>
            </div>

            <!-- Manage Movies -->
            <div class="action-card">
                <h3 style="color: var(--secondary-color); margin-bottom: 1rem;">Manage Movies</h3>
                <p style="color: #b0b0b0; margin-bottom: 1.5rem;">View, edit, or delete existing movies</p>
                <a href="manage_movies.html" class="btn">Manage Movies</a>
            </div>

            <!-- Manage Reviews -->
            <div class="action-card">
                <h3 style="color: var(--secondary-color); margin-bottom: 1rem;">Manage Reviews</h3>
                <p style="color: #b0b0b0; margin-bottom: 1.5rem;">Review and moderate user submissions</p>
                <a href="manage_reviews.html" class="btn">Manage Reviews</a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="head-style" style="margin-top: 3rem;">
            <h2>Recent Activity</h2>
            <p>Latest <span>Updates</span></p>
        </div>

        <div class="recent-activity" id="recentActivity">
            <div class="item">
                <p style="color: var(--secondary-color); margin-bottom: 0.3rem;">Loading recent activity...</p>
                <p style="color: #7f7f90; font-size: 0.9rem;">Just now</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 MovieReview. All rights reserved.</p>
            <p>Admin Dashboard - Manage your movie review platform.</p>
        </div>
    </footer>

    <script>
        // Function to get all movies from localStorage
        function getAllMovies() {
            const movies = localStorage.getItem('movies');
            if (movies) {
                try {
                    const moviesArray = JSON.parse(movies);
                    // Convert array to object with movieId as key for backward compatibility
                    const moviesObj = {};
                    moviesArray.forEach(movie => {
                        const movieId = movie.movieId || movie.id || generateMovieId(movie.title);
                        moviesObj[movieId] = {
                            title: movie.title,
                            image: movie.poster || movie.image || '../../assets/img/movies/default.jpg',
                            genre: movie.additionalGenres ? `${movie.genre || ''}, ${movie.additionalGenres}` : (movie.genre || ''),
                            year: movie.releaseYear || movie.year || '',
                            movieId: movieId,
                            director: movie.director || '',
                            description: movie.description || '',
                            cast: movie.cast || '',
                            duration: movie.duration || '',
                            rating: movie.rating || '',
                            language: movie.language || '',
                            country: movie.country || '',
                            trailer: movie.trailer || ''
                        };
                    });
                    return moviesObj;
                } catch (e) {
                    console.error('Error parsing movies from localStorage:', e);
                    return getDefaultMovies();
                }
            }
            // Fallback to default movies for backward compatibility
            return getDefaultMovies();
        }

        // Function to generate movie ID from title
        function generateMovieId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        // Default movies for backward compatibility
        function getDefaultMovies() {
            return {
                'the-shawshank-redemption': {
                    title: 'The Shawshank Redemption',
                    image: '../../assets/img/movies/shaw.jpg',
                    genre: 'Drama',
                    year: '1994',
                    movieId: 'the-shawshank-redemption'
                },
                'the-dark-knight': {
                    title: 'The Dark Knight',
                    image: '../../assets/img/movies/R.jpeg',
                    genre: 'Action, Crime',
                    year: '2008',
                    movieId: 'the-dark-knight'
                },
                'the-godfather': {
                    title: 'The Godfather',
                    image: '../../assets/img/movies/godf.jpg',
                    genre: 'Crime, Drama',
                    year: '1972',
                    movieId: 'the-godfather'
                }
            };
        }

        // Function to get all users from localStorage
        function getAllUsers() {
            const users = localStorage.getItem('users');
            return users ? JSON.parse(users) : [];
        }

        // Function to get reviews from local storage
        function getReviews(movieId) {
            const reviews = localStorage.getItem(`reviews_${movieId}`);
            return reviews ? JSON.parse(reviews) : [];
        }

        // Function to get all reviews across all movies
        function getAllReviews() {
            let allReviews = [];
            const movieData = getAllMovies();
            Object.keys(movieData).forEach(movieId => {
                const reviews = getReviews(movieId);
                // Add movieId to each review so we can track which movie it belongs to
                const reviewsWithMovieId = reviews.map(review => ({
                    ...review,
                    movieId: review.movieId || movieId
                }));
                allReviews = allReviews.concat(reviewsWithMovieId);
            });
            return allReviews;
        }

        // Function to get movies that have been reviewed
        function getMoviesWithReviews() {
            const reviewedMovies = [];
            const movieData = getAllMovies();
            Object.keys(movieData).forEach(movieId => {
                const reviews = getReviews(movieId);
                if (reviews.length > 0) {
                    reviewedMovies.push({
                        ...movieData[movieId],
                        reviewCount: reviews.length
                    });
                }
            });
            return reviewedMovies;
        }

        // Function to parse review date safely
        // Reviews have an 'id' field that is Date.now() timestamp - use that for accurate dates
        function parseReviewDate(review) {
            // First, try to use the review ID as timestamp (most accurate)
            if (review.id && typeof review.id === 'number' && review.id > 0) {
                const dateFromId = new Date(review.id);
                if (!isNaN(dateFromId.getTime())) {
                    return dateFromId;
                }
            }
            
            // Fallback: try to parse date and time strings
            const dateString = review.date;
            const timeString = review.time;
            
            if (!dateString) {
                // If no date, use current date as fallback
                return new Date();
            }
            
            try {
                // Try parsing the date string directly first
                let date = new Date(dateString);
                
                // If that fails or gives invalid date, try parsing with time
                if (isNaN(date.getTime()) && timeString) {
                    date = new Date(dateString + ' ' + timeString);
                }
                
                // If still invalid, try common date formats
                if (isNaN(date.getTime())) {
                    // Try MM/DD/YYYY or DD/MM/YYYY format
                    const parts = dateString.split(/[\/\-]/);
                    if (parts.length === 3) {
                        // Try MM/DD/YYYY (US format) first
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                        if (isNaN(date.getTime())) {
                            // Try DD/MM/YYYY (European format)
                            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                        }
                    }
                }
                
                // If still invalid, use current date as fallback
                if (isNaN(date.getTime())) {
                    return new Date(); // Use current date as fallback
                }
                
                // Add time if provided
                if (timeString && !isNaN(date.getTime())) {
                    const timeParts = timeString.match(/(\d+):(\d+)(?::(\d+))?\s*(AM|PM)?/i);
                    if (timeParts) {
                        let hours = parseInt(timeParts[1]);
                        const minutes = parseInt(timeParts[2]);
                        const seconds = timeParts[3] ? parseInt(timeParts[3]) : 0;
                        const ampm = timeParts[4];
                        
                        if (ampm) {
                            if (ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
                            if (ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
                        }
                        
                        date.setHours(hours, minutes, seconds);
                    }
                }
                
                return date;
            } catch (e) {
                // If all parsing fails, use current date
                return new Date();
            }
        }

        // Function to get recent activity (latest reviews and user registrations)
        function getRecentActivity() {
            const activities = [];
            const movieData = getAllMovies();
            
            // Get latest reviews
            const allReviews = getAllReviews();
            const sortedReviews = allReviews.sort((a, b) => {
                const dateA = parseReviewDate(a);
                const dateB = parseReviewDate(b);
                return dateB - dateA;
            });
            
            // Add recent reviews to activities
            sortedReviews.slice(0, 5).forEach(review => {
                const timestamp = parseReviewDate(review);
                // Format the date nicely for display
                const displayDate = timestamp.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const displayTime = timestamp.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                activities.push({
                    type: 'review',
                    message: `New review by ${review.user || 'Anonymous'} on ${movieData[review.movieId]?.title || 'a movie'}`,
                    time: `${displayDate} ${displayTime}`,
                    timestamp: timestamp
                });
            });
            
            // Get recent user registrations
            const users = getAllUsers();
            const sortedUsers = users.filter(user => user.createdAt).sort((a, b) => {
                const dateA = new Date(a.createdAt);
                const dateB = new Date(b.createdAt);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });
            
            // Add recent user registrations to activities
            sortedUsers.slice(0, 3).forEach(user => {
                if (user.createdAt) {
                    const timestamp = new Date(user.createdAt);
                    if (!isNaN(timestamp.getTime())) {
                        activities.push({
                            type: 'user',
                            message: `New user registered: ${user.name || 'User'} (${user.role || 'user'})`,
                            time: timestamp.toLocaleDateString(),
                            timestamp: timestamp
                        });
                    }
                }
            });
            
            // Sort all activities by timestamp (newest first) and filter out invalid dates
            return activities
                .filter(activity => activity.timestamp && !isNaN(activity.timestamp.getTime()))
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 6);
        }

        // Function to format relative time
        function getRelativeTime(timestamp) {
            if (!timestamp || isNaN(timestamp.getTime())) {
                return 'Recently';
            }
            
            const now = new Date();
            const diff = now - timestamp;
            
            // Handle negative differences (future dates)
            if (diff < 0) {
                return timestamp.toLocaleDateString();
            }
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return timestamp.toLocaleDateString();
        }

        // Function to update dashboard statistics
        function updateDashboardStats() {
            // Update admin name
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.name) {
                document.getElementById('adminName').textContent = currentUser.name;
            }
            
            // Get data
            const movieData = getAllMovies();
            const users = getAllUsers();
            const allReviews = getAllReviews();
            const reviewedMovies = getMoviesWithReviews();
            
            // Update statistics
            document.getElementById('totalMovies').textContent = Object.keys(movieData).length;
            document.getElementById('totalReviews').textContent = allReviews.length;
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('moviesReviewed').textContent = reviewedMovies.length;
            
            // Update recent activity
            const recentActivity = getRecentActivity();
            const activityContainer = document.getElementById('recentActivity');
            
            if (recentActivity.length === 0) {
                activityContainer.innerHTML = `
                    <div class="item">
                        <p style="color: var(--secondary-color); margin-bottom: 0.3rem;">No recent activity yet</p>
                        <p style="color: #7f7f90; font-size: 0.9rem;">Activity will appear here</p>
                    </div>
                `;
            } else {
                activityContainer.innerHTML = recentActivity.map(activity => {
                    const typeClass = activity.type === 'review' ? 'alt-green' : 'alt-primary';
                    return `
                        <div class="item ${typeClass}">
                            <p style="color: var(--secondary-color); margin-bottom: 0.3rem;">${activity.message}</p>
                            <p style="color: #7f7f90; font-size: 0.9rem;">${getRelativeTime(activity.timestamp)}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboardStats();
            
            // Update stats every 30 seconds
            setInterval(updateDashboardStats, 30000);
        });
    </script>
</body>
</html>