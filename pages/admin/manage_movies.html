<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Movies - Admin | MovieReview</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Admin Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <h1><a href="home.html">Movie<span>Review</span> Admin</a></h1>
                <ul>
                    <li><a href="home.html">Dashboard</a></li>
                    <li><a href="add_movie.html">Add Movie</a></li>
                    <li><a href="manage_movies.html">Manage Movies</a></li>
                    <li><a href="manage_reviews.html">Manage Reviews</a></li>
                    <li><a href="../auth/logout.html">Logout</a></li>
                </ul>
                <div class="bar-icon">â˜°</div>
            </div>
        </div>
    </nav>
    <div class="content-with-sidebar no-sidebar">
        <div class="container">
            <h2>Manage Movies</h2>
            <div class="admin-panel">
                <button class="btn" style="margin-bottom:1rem;" onclick="location.href='add_movie.html'">
                    <i class="fas fa-plus"></i> Add New Movie
                </button>

                <!-- Message area for feedback -->
                <div id="messageArea" style="margin-bottom: 1rem;"></div>

                <table class="admin-table">
                    <thead>
                        <tr style="background:#333;">
                            <th style="padding:10px;">Poster</th>
                            <th>Title</th>
                            <th>Genre</th>
                            <th>Year</th>
                            <th>Director</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="moviesTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                Loading movies...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Movie Modal -->
    <div id="editMovieModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
        <div style="background: #1a1a1a; margin: 2rem auto; max-width: 600px; padding: 2rem; border-radius: 10px; position: relative;">
            <button id="closeModal" style="position: absolute; top: 1rem; right: 1rem; background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            <h2 style="margin-bottom: 1.5rem;">Edit Movie</h2>
            <form id="editMovieForm">
                <input type="hidden" id="editMovieId">
                
                <label for="editTitle">Movie Title *</label>
                <input type="text" id="editTitle" name="title" required placeholder="Enter movie title" minlength="1" maxlength="200">

                <label for="editGenre">Genre *</label>
                <select id="editGenre" name="genre" required>
                    <option value="">Select primary genre</option>
                    <option value="Action">Action</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Animation">Animation</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Crime">Crime</option>
                    <option value="Documentary">Documentary</option>
                    <option value="Drama">Drama</option>
                    <option value="Fantasy">Fantasy</option>
                    <option value="Horror">Horror</option>
                    <option value="Mystery">Mystery</option>
                    <option value="Romance">Romance</option>
                    <option value="Sci-Fi">Sci-Fi</option>
                    <option value="Thriller">Thriller</option>
                    <option value="Western">Western</option>
                </select>

                <label for="editAdditionalGenres">Additional Genres (Optional)</label>
                <input type="text" id="editAdditionalGenres" name="additionalGenres" placeholder="e.g., Thriller, Mystery (comma-separated)">

                <label for="editReleaseYear">Release Year *</label>
                <input type="number" id="editReleaseYear" name="releaseYear" required placeholder="Enter release year" min="1888" max="2025">

                <label for="editDirector">Director *</label>
                <input type="text" id="editDirector" name="director" required placeholder="Enter director name" minlength="2">

                <label for="editCast">Main Cast (Optional)</label>
                <input type="text" id="editCast" name="cast" placeholder="e.g., Actor 1, Actor 2, Actor 3 (comma-separated)">

                <label for="editDuration">Duration (minutes)</label>
                <input type="number" id="editDuration" name="duration" placeholder="Enter movie duration in minutes" min="1">

                <label for="editRating">Content Rating (Optional)</label>
                <select id="editRating" name="rating">
                    <option value="">Select content rating</option>
                    <option value="G">G - General Audiences</option>
                    <option value="PG">PG - Parental Guidance Suggested</option>
                    <option value="PG-13">PG-13 - Parents Strongly Cautioned</option>
                    <option value="R">R - Restricted</option>
                    <option value="NC-17">NC-17 - Adults Only</option>
                </select>

                <label for="editImdbRating">IMDb Rating (out of 10) *</label>
                <input type="number" id="editImdbRating" name="imdbRating" required placeholder="Enter IMDb rating (e.g., 8.5)" min="0" max="10" step="0.1">

                <label for="editDescription">Description *</label>
                <textarea id="editDescription" name="description" required placeholder="Enter movie description/plot summary" rows="6" minlength="20"></textarea>

                <label for="editPoster">Poster Image URL</label>
                <input type="url" id="editPoster" name="poster" placeholder="Enter poster image URL">

                <label for="editTrailer">Trailer URL (Optional)</label>
                <input type="url" id="editTrailer" name="trailer" placeholder="Enter trailer URL">

                <label for="editLanguage">Language *</label>
                <input type="text" id="editLanguage" name="language" required placeholder="Enter primary language" value="English">

                <label for="editCountry">Country *</label>
                <input type="text" id="editCountry" name="country" required placeholder="Enter country of origin" value="USA">

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn">Update Movie</button>
                    <button type="button" class="btn reset" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../assets/js/admin.js"></script>
    <script>
        // Fallback functions if admin.js doesn't load
        if (typeof generateMovieId === 'undefined') {
            window.generateMovieId = function(title) {
                return title.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            };
        }
        if (typeof getMoviesArray === 'undefined') {
            window.getMoviesArray = function() {
                const movies = localStorage.getItem('movies');
                if (movies) {
                    try {
                        return JSON.parse(movies);
                    } catch (e) {
                        console.error('Error parsing movies from localStorage:', e);
                        return [];
                    }
                }
                return [];
            };
        }
        if (typeof saveMoviesArray === 'undefined') {
            window.saveMoviesArray = function(movies) {
                localStorage.setItem('movies', JSON.stringify(movies));
            };
        }
        if (typeof initializeDefaultMovies === 'undefined') {
            window.initializeDefaultMovies = function() {
                const existingMovies = getMoviesArray();
                if (existingMovies.length === 0) {
                    const defaultMovies = [
                        {
                            movieId: 'the-shawshank-redemption',
                            title: 'The Shawshank Redemption',
                            genre: 'Drama',
                            additionalGenres: '',
                            releaseYear: 1994,
                            director: 'Frank Darabont',
                            cast: 'Tim Robbins, Morgan Freeman, Bob Gunton',
                            duration: 142,
                            rating: 'R',
                            imdbRating: 9.3,
                            description: 'Two imprisoned men bond over years, finding solace and eventual redemption through acts of common decency. The film captures the essence of hope and humanity in the darkest of times.',
                            poster: '../../assets/img/movies/shaw.jpg',
                            image: '../../assets/img/movies/shaw.jpg',
                            trailer: '',
                            language: 'English',
                            country: 'USA',
                            createdAt: new Date().toISOString()
                        },
                        {
                            movieId: 'the-dark-knight',
                            title: 'The Dark Knight',
                            genre: 'Action',
                            additionalGenres: 'Crime, Drama',
                            releaseYear: 2008,
                            director: 'Christopher Nolan',
                            cast: 'Christian Bale, Heath Ledger, Aaron Eckhart',
                            duration: 152,
                            rating: 'PG-13',
                            imdbRating: 9.0,
                            description: 'When the menace known as the Joker causes chaos in Gotham, Batman faces his greatest moral test yet. A psychological thriller that explores the fine line between hero and vigilante.',
                            poster: '../../assets/img/movies/R.jpeg',
                            image: '../../assets/img/movies/R.jpeg',
                            trailer: '',
                            language: 'English',
                            country: 'USA',
                            createdAt: new Date().toISOString()
                        },
                        {
                            movieId: 'the-godfather',
                            title: 'The Godfather',
                            genre: 'Crime',
                            additionalGenres: 'Drama',
                            releaseYear: 1972,
                            director: 'Francis Ford Coppola',
                            cast: 'Marlon Brando, Al Pacino, James Caan',
                            duration: 175,
                            rating: 'R',
                            imdbRating: 9.2,
                            description: 'The aging patriarch of an organized crime dynasty transfers control of his empire to his reluctant son. A powerful tale of family, loyalty, and the corrupting influence of power.',
                            poster: '../../assets/img/movies/godf.jpg',
                            image: '../../assets/img/movies/godf.jpg',
                            trailer: '',
                            language: 'English',
                            country: 'USA',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    saveMoviesArray(defaultMovies);
                    return true;
                }
                return false;
            };
        }
    </script>
    <script>
        // Function to show message
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) {
                console.error('Message area not found');
                return;
            }
            messageArea.innerHTML = `<div style="background-color: ${type === 'success' ? '#4CAF50' : '#f44336'}; color: white; padding: 1rem; border-radius: 5px; text-align: center;">${message}</div>`;
            setTimeout(() => {
                if (messageArea) {
                    messageArea.innerHTML = '';
                }
            }, 3000);
        }

        // Function to load and display movies
        function loadMovies() {
            try {
                // Check if functions are available
                if (typeof getMoviesArray !== 'function') {
                    console.error('getMoviesArray function not found');
                    const tbody = document.getElementById('moviesTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #f44336;">
                                    Error: Admin functions not loaded. Please refresh the page.
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                const movies = getMoviesArray();
                const tbody = document.getElementById('moviesTableBody');
                
                if (!tbody) {
                    console.error('Table body not found');
                    return;
                }
                
                if (!movies || movies.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                No movies found. <a href="add_movie.html" style="color: var(--primary-color);">Add your first movie</a>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Filter out any null/undefined movies
                const validMovies = movies.filter(movie => movie && movie.title);
                
                if (validMovies.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                No valid movies found. <a href="add_movie.html" style="color: var(--primary-color);">Add your first movie</a>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = validMovies.map(movie => {
                    const movieId = movie.movieId || movie.id || (typeof generateMovieId === 'function' ? generateMovieId(movie.title) : (movie.title || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'));
                    const imageSrc = movie.poster || movie.image || '../../assets/img/movies/default.jpg';
                    const genre = movie.additionalGenres ? `${movie.genre || ''}, ${movie.additionalGenres}`.trim() : (movie.genre || 'N/A');
                    const year = movie.releaseYear || movie.year || 'N/A';
                    const director = movie.director || 'N/A';
                    const title = movie.title || 'Untitled';
                    
                    // Escape strings for use in HTML attributes
                    const escapedMovieId = String(movieId).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const escapedTitle = title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                        <tr>
                            <td>
                                <img class="admin-thumb" src="${imageSrc}" alt="${title.replace(/"/g, '&quot;')}" onerror="this.src='../../assets/img/movies/default.jpg'">
                            </td>
                            <td>${title}</td>
                            <td>${genre}</td>
                            <td>${year}</td>
                            <td>${director}</td>
                            <td>
                                <button class="btn edit-btn" onclick="editMovie('${escapedMovieId}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn delete-btn" onclick="deleteMovie('${escapedMovieId}', '${escapedTitle}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading movies:', error);
                const tbody = document.getElementById('moviesTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #f44336;">
                                Error loading movies: ${error.message || 'Unknown error'}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Function to edit movie
        window.editMovie = function(movieId) {
            try {
                if (typeof getMoviesArray !== 'function') {
                    showMessage('Error: Admin functions not loaded.', 'error');
                    return;
                }
                
                const movies = getMoviesArray();
                const movie = movies.find(m => {
                    const id = m.movieId || m.id || (typeof generateMovieId === 'function' ? generateMovieId(m.title) : m.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'));
                    return id === movieId;
                });
                
                if (!movie) {
                    showMessage('Movie not found.', 'error');
                    return;
                }
                
                // Populate form
                const editMovieId = document.getElementById('editMovieId');
                const editTitle = document.getElementById('editTitle');
                const editGenre = document.getElementById('editGenre');
                const editAdditionalGenres = document.getElementById('editAdditionalGenres');
                const editReleaseYear = document.getElementById('editReleaseYear');
                const editDirector = document.getElementById('editDirector');
                const editCast = document.getElementById('editCast');
                const editDuration = document.getElementById('editDuration');
                const editRating = document.getElementById('editRating');
                const editImdbRating = document.getElementById('editImdbRating');
                const editDescription = document.getElementById('editDescription');
                const editPoster = document.getElementById('editPoster');
                const editTrailer = document.getElementById('editTrailer');
                const editLanguage = document.getElementById('editLanguage');
                const editCountry = document.getElementById('editCountry');
                
                if (editMovieId) editMovieId.value = movieId;
                if (editTitle) editTitle.value = movie.title || '';
                if (editGenre) editGenre.value = movie.genre || '';
                if (editAdditionalGenres) editAdditionalGenres.value = movie.additionalGenres || '';
                if (editReleaseYear) editReleaseYear.value = movie.releaseYear || movie.year || '';
                if (editDirector) editDirector.value = movie.director || '';
                if (editCast) editCast.value = movie.cast || '';
                if (editDuration) editDuration.value = movie.duration || '';
                if (editRating) editRating.value = movie.rating || '';
                if (editImdbRating) editImdbRating.value = movie.imdbRating || '';
                if (editDescription) editDescription.value = movie.description || '';
                if (editPoster) editPoster.value = movie.poster || movie.image || '';
                if (editTrailer) editTrailer.value = movie.trailer || '';
                if (editLanguage) editLanguage.value = movie.language || 'English';
                if (editCountry) editCountry.value = movie.country || 'USA';
                
                // Show modal
                const modal = document.getElementById('editMovieModal');
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    showMessage('Edit modal not found.', 'error');
                }
            } catch (error) {
                console.error('Error editing movie:', error);
                showMessage('Error editing movie: ' + error.message, 'error');
            }
        };

        // Function to close edit modal
        window.closeEditModal = function() {
            document.getElementById('editMovieModal').style.display = 'none';
            document.getElementById('editMovieForm').reset();
        };

        // Function to delete movie
        window.deleteMovie = function(movieId, movieTitle) {
            try {
                if (!confirm(`Are you sure you want to delete "${movieTitle}"?\n\nThis action cannot be undone and will also delete all reviews for this movie.`)) {
                    return;
                }
                
                if (!movieId) {
                    showMessage('Invalid movie ID.', 'error');
                    return;
                }
                
                if (typeof getMoviesArray !== 'function' || typeof saveMoviesArray !== 'function') {
                    showMessage('Error: Admin functions not loaded.', 'error');
                    return;
                }
                
                const movies = getMoviesArray();
                if (!movies || !Array.isArray(movies) || movies.length === 0) {
                    showMessage('No movies found.', 'error');
                    return;
                }
                
                // Filter out the movie to delete
                const movieIdStr = String(movieId);
                const filteredMovies = movies.filter(m => {
                    if (!m || !m.title) return false;
                    const id = m.movieId || m.id || (typeof generateMovieId === 'function' ? generateMovieId(m.title) : (m.title || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'));
                    const currentIdStr = String(id);
                    return currentIdStr !== movieIdStr;
                });
                
                if (filteredMovies.length === movies.length) {
                    showMessage('Movie not found. It may have already been deleted.', 'error');
                    loadMovies(); // Refresh anyway
                    return;
                }
                
                // Delete associated reviews
                localStorage.removeItem(`reviews_${movieId}`);
                
                // Save updated movies (or clear if no movies left)
                if (filteredMovies.length > 0) {
                    saveMoviesArray(filteredMovies);
                } else {
                    localStorage.removeItem('movies');
                }
                
                showMessage(`Movie "${movieTitle}" has been deleted successfully.`, 'success');
                loadMovies();
            } catch (error) {
                console.error('Error deleting movie:', error);
                showMessage('Error deleting movie: ' + error.message, 'error');
            }
        };

        // Handle edit form submission
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Ensure functions are available (use fallbacks if needed)
                if (typeof initializeDefaultMovies !== 'function') {
                    console.warn('initializeDefaultMovies not found, using fallback');
                }
                if (typeof getMoviesArray !== 'function') {
                    console.error('getMoviesArray function not available');
                    const tbody = document.getElementById('moviesTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #f44336;">
                                    Error: Required functions not loaded. Please refresh the page.
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }
                
                // Initialize default movies if localStorage is empty
                if (typeof initializeDefaultMovies === 'function') {
                    const initialized = initializeDefaultMovies();
                    if (initialized) {
                        showMessage('Default movies have been loaded. You can now manage them!', 'success');
                    }
                }
                
                // Load and display movies
                loadMovies();
                
                // Close modal on X button
                const closeBtn = document.getElementById('closeModal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeEditModal);
                }
                
                // Close modal on outside click
                const modal = document.getElementById('editMovieModal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeEditModal();
                        }
                    });
                }
                
                // Handle edit form submission
                const editForm = document.getElementById('editMovieForm');
                if (!editForm) {
                    console.error('Edit form not found');
                    return;
                }
                
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    try {
                        if (typeof getMoviesArray !== 'function' || typeof saveMoviesArray !== 'function') {
                            showMessage('Error: Admin functions not loaded.', 'error');
                            return;
                        }
                        
                        const movieId = document.getElementById('editMovieId').value;
                        const movies = getMoviesArray();
                        const movieIndex = movies.findIndex(m => {
                            const id = m.movieId || m.id || (typeof generateMovieId === 'function' ? generateMovieId(m.title) : m.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'));
                            return id === movieId;
                        });
                        
                        if (movieIndex === -1) {
                            showMessage('Movie not found.', 'error');
                            return;
                        }
                        
                        // Get form values
                        const updatedMovie = {
                            ...movies[movieIndex],
                            title: document.getElementById('editTitle').value.trim(),
                            genre: document.getElementById('editGenre').value,
                            additionalGenres: document.getElementById('editAdditionalGenres').value.trim(),
                            releaseYear: parseInt(document.getElementById('editReleaseYear').value),
                            director: document.getElementById('editDirector').value.trim(),
                            cast: document.getElementById('editCast').value.trim(),
                            duration: document.getElementById('editDuration').value ? parseInt(document.getElementById('editDuration').value) : null,
                            rating: document.getElementById('editRating').value,
                            imdbRating: document.getElementById('editImdbRating').value ? parseFloat(document.getElementById('editImdbRating').value) : null,
                            description: document.getElementById('editDescription').value.trim(),
                            poster: document.getElementById('editPoster').value.trim(),
                            trailer: document.getElementById('editTrailer').value.trim(),
                            language: document.getElementById('editLanguage').value.trim(),
                            country: document.getElementById('editCountry').value.trim(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Update movie
                        movies[movieIndex] = updatedMovie;
                        saveMoviesArray(movies);
                        
                        showMessage(`Movie "${updatedMovie.title}" has been updated successfully.`, 'success');
                        closeEditModal();
                        loadMovies();
                    } catch (error) {
                        console.error('Error updating movie:', error);
                        showMessage('Error updating movie: ' + error.message, 'error');
                    }
                });
            } catch (error) {
                console.error('Error initializing page:', error);
                showMessage('Error initializing page: ' + error.message, 'error');
            }
        });
    </script>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 MovieReview. All rights reserved.</p>
            <p>Admin Dashboard - Manage your movie review platform.</p>
        </div>
    </footer>
</body>
</html>
